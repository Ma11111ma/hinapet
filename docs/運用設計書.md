# docs/runbook.md（運用設計書）

## 1. 目的

本番/ステージングの運用手順、監視、障害対応、変更管理、バックアップ/リストアを定義します。

## 2. 環境

| 環境       | URL                                    | デプロイ                   | 認証     | DB                 |
| ---------- | -------------------------------------- | -------------------------- | -------- | ------------------ |
| Staging    | http://localhost:3000/                 | GitHub Actions（main→stg） | Firebase | PostGIS            |
| Production | https://pet-evacuation-app.vercel.app/ | GitHub Actions（tag v\*）  | Firebase | PostGIS（HA 予定） |

## 3. リリース手順（例）

1. main にマージ → CI 自動テスト → Staging デプロイ
2. E2E 確認（チェックリスト）
3. タグ付け `vX.Y.Z` → Prod デプロイ
4. ヘルスチェック/ログ監視 10 分 → 正常なら完了

## 4. 監視

- Uptime/ヘルス：/healthz（FastAPI）
- 指標（SLI）：API 5xx 率、p95 応答時間、エラー率、DB 接続数、LCP/FID（RUM）
- ログ：JSON 構造化ログ（trace_id、user_id、route、latency_ms、status）
- アラート例：5xx > 1%（5 分移動平均）、/shelters p95 > 500ms（10 分）

## 5. 障害対応（インシデント・フロー）

- 検知 → 当番が一次対応（15 分以内） → ロールバック or フィックス
- 重大度（SEV）定義：SEV-1（全停止）、SEV-2（一部機能停止）、…
- コミュニケーション：Slack #incident、ステータスページ更新
- 事後レビュー：24h 以内にポストモーテム（原因/影響/再発防止策）

## 6. 変更管理

- すべて PR 経由、CI グリーン必須、2 名レビュー（本番影響大は必須）
- フィーチャーフラグ利用（段階的リリース）

## 7. バックアップ/リストア

- DB：毎日フル、15 分ごと WAL（保持 30 日）
- RPO：≤15 分、RTO：≤60 分
- 手順：最新フル + WAL 適用 → 整合性検証 → 切替

## 8. セキュリティ運用

- Secrets：.env は Vault/CI シークレット管理、平文禁止
- 依存性スキャン：週次（GitHub Dependabot/SCA）
- 権限：原則最小権限、Prod DB 直アクセス禁止（只読ジャンプ）

## 9. キャパシティ/スケーリング

- 目標同時接続数：N（見積り表参照）
- スケール：Web/API 水平スケール、DB リードレプリカ検討
- 事前ロードテストの阈値超過で上げ幅/上限を定義

---

### 作成時の注意点

- **誰が読んでも再現できる**作業手順（コマンド/期待結果）にする。
- **検証可能な基準**（RTO/RPO、アラート閾値）を数値で明記。
- **運用の SPOF 排除**（当番/バックアップ体制、権限委譲）。
