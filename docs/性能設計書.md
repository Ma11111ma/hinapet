# docs/performance_design.md（性能設計書）

## 1. 目的と対象

UI 応答、API、DB、ネットワークの性能目標と達成手段を定義。

## 2. SLI/SLO

| レイヤ     | 指標(SLI)  | SLO(p75/p95)             |
| ---------- | ---------- | ------------------------ |
| Web（LCP） | LCP        | p75 ≤ 2.5s               |
| API        | 応答時間   | p95 ≤ 300ms（/shelters） |
| API        | 5xx 率     | < 0.5% / 日              |
| DB         | クエリ時間 | p95 ≤ 50ms（距離検索）   |

## 3. ワークロード想定

- ピーク同時ユーザー：X、人/分クエリ：Y
- ホットパス：地図初期ロード → /shelters（半径 1–5km）

## 4. アーキ設計（性能観点）

- CDN + キャッシュ制御（静的アセット、地図タイルはベンダ依存）
- API：読み取り中心はキャッシュ層（短 TTL、座標/パラメータでキー化）
- DB：PostGIS GiST インデックス（geom）、`ST_DWithin` + `ST_Distance`
- ページング：`LIMIT/OFFSET` or keyset、1 ページ ≤ 50 件
- N+1 回避：必要項目のみ選択、JSON レスポンス最小化
- 並列/非同期：FastAPI の非同期、DB プール設定（min/max、タイムアウト）

## 5. 持続的計測

- RUM：Web-Vitals（LCP、FID、CLS）
- サーバ：APM（トレース ID で API⇄DB 相関）、メトリクス（latency_ms、qps）
- ロードテスト：k6/Locust（シナリオ=初期表示 → 検索 → モーダル）

## 6. チューニング方針

1. 可視化（APM/メトリクス/ログ）
2. ボトルネック同定（p95 中心）
3. 低コスト改善（インデックス/キャッシュ/JSON 圧縮）
4. コード/クエリ改善
5. 水平スケール

## 7. リスクと対策

- 地図コンポーネントの初期ペイロード肥大 → Code-Splitting/遅延読み込み
- 広域検索のレスポンス劣化 → 最大半径制限、サーバ側で上限
- モバイル回線 → 画像最適化、HTTP 圧縮、プリロード制御

---

### 作成時の注意点

- **測れる SLO**を先に決め、**実装より計測基盤**を先行させる。
- 空間検索は**インデックス前提**で設計（GiST/距離関数の組合せを固定）。
- キャッシュは**一貫性要件**と**TTL**を明文化（古い値の影響範囲）。
