# docs/test_plan.md（テスト設計書）

## 1. 目的

本ドキュメントは「ペット避難所アプリ」の品質目標、テスト範囲、観点、進め方、合格基準を定義します。

## 2. 品質目標（Quality Goals）

- 機能適合性：MVP 要件を 100%満たす（B-1〜B-5、最低限の A 群 API）
- 信頼性：API 5xx 率 < 0.5% / 日、クラッシュフリーセッション ≥ 99.9%
- 性能：主要 3 画面 LCP ≤ 2.5s（p75）、/shelters 検索 API p95 ≤ 300ms
- セキュリティ：OWASP ASVS L1 主要チェックを満たす、脆弱性スキャン Critical/High 0 件
- 可用性：稼働率 99.5% 以上（MVP 段階）

## 3. スコープ

### 3.1 対象機能

- フロント：地図表示、ピン色分け、モーダル、検索、経路表示（将来）
- バックエンド：/shelters 検索、/favorites、/users/me 認証関連
- データ：PostGIS 検索（距離、型別フィルタ）、シーディング、マイグレーション
- 認証：Firebase Auth トークン検証（FastAPI 依存関数）

### 3.2 対象外（現段階）

- 課金、通知、B2G 管理機能（今後の M3 以降）

## 4. テストレベル

- 単体（フロント：Vitest、バック：pytest）
- 結合（API ⇄ DB、API ⇄ フロント）
- E2E（Playwright）
- 非機能（負荷・性能、セキュリティ静的/依存性）

## 5. テスト観点（例）

| 観点             | 例                                                   |
| ---------------- | ---------------------------------------------------- |
| 正常系           | 地図初期表示、現在地取得、ピンクリックでモーダル表示 |
| 異常系           | API タイムアウト、0 件時表示、オフライン、権限不足   |
| 境界             | 半径検索の距離閾値、ページング境界、最大件数         |
| i18n/表記        | 日本語表記、数値桁区切り、単位（km/m）               |
| レイアウト       | モバイル/PC ブレークポイント                         |
| アクセシビリティ | キーボード操作（ESC でモーダル閉）、alt/aria         |

## 6. 受け入れ基準（DoD）

- 単体：行カバレッジ 80% 以上、重要分岐 100%
- 結合：主要 API の正常/異常パス網羅
- E2E：主要ユーザーストーリー（検索 → ピン → モーダル → お気に入り）を p95 < 20s で完走
- CI：lint/test/build が main で常時グリーン
- 既知不具合：Critical/High 0 件

## 7. テストケース例（抜粋）

### 7.1 フロント（Playwright/E2E）

- TC-FE-001：地図初期表示でピンが 10 件以上表示される  
  前提：/shelters シード済み  
  手順：トップアクセス → マップ描画待ち → ピン要素数取得  
  期待：件数 ≥ 10、JS エラー 0

- TC-FE-010：ピンをクリックするとモーダルが開閉できる（ESC/背景クリック）  
  期待：モーダル Open 後、ESC で Close、背景クリックでも Close

### 7.2 API（pytest）

- TC-API-100：/shelters?lat=..&lng=..&radius=1000  
  期待：HTTP 200、返却件数 ≤ 50、各要素に id/name/type/lat/lng が存在

- TC-API-130：/users/me（未認証）  
  期待：HTTP 401、エラーメッセージ

## 8. テストデータ

- seed_shelters.py による固定データ（都市/郊外/ゼロ件領域）
- 境界検証用に距離が閾値 ±1m のペア

## 9. ツールと実行

- フロント：`pnpm test`（vitest）、`pnpm e2e`（playwright）
- バック：`pytest -q --cov=app`
- 負荷：k6 or Locust（/shelters 検索 p95 指標計測）

## 10. トレースとバグ管理

- GitHub Issues/Projects、バグテンプレート必須（再現手順/期待/実際/ログ/スクショ/環境）
- ラベル：bug/severity:high/area:frontend 等

## 11. リスク

- 外部 API（Maps, Auth）障害の影響
- 地理データ不整合（座標/型）
- モバイル端末差異

---

### 作成時の注意点

- **要求ベース**で観点を落とす（PRD やユーザーストーリーと 1 対 1 対応）。
- **非機能**（性能/可用性/セキュリティ）を最初から数値化（SLI/SLO）する。
- **データ依存**のテストを固定 seed で再現性確保。
- **異常系**・**境界**・**無風時（0 件）** の UI を必ず含める。
