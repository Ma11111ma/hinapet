# docs/security_design.md（セキュリティ設計書）

## 1. 目標と方針

- 最小権限、セキュアデフォルト、監査可能性、脆弱性の早期検出

## 2. データ分類

| 区分   | 例                                       | 保護レベル |
| ------ | ---------------------------------------- | ---------- |
| 機微   | 個人識別情報（必要最小限）、認証トークン | 高         |
| 準機微 | 位置情報（丸め/匿名化）                  | 中         |
| 一般   | 公開避難所情報                           | 低         |

## 3. 認証/認可

- 認証：Firebase Auth（ID トークン検証を FastAPI で実施）
- 認可：ロール（user/admin）、エンドポイント単位の Depends
- セッション：トークンはストレージ保管方針（XSS 対策、httpOnly 推奨）

## 4. 入力検証/出力エンコード

- API スキーマ検証（pydantic）
- XSS/HTML エスケープ（フロント）
- クエリ制限：radius、件数、座標範囲の上限

## 5. 通信/秘密情報

- HTTPS/TLS1.2+ 強制、HSTS
- Secrets は Vault/CI 管理、ローカルは .env.local（配布禁止）
- 署名鍵のローテーションポリシー

## 6. 依存性/ビルド

- 依存性スキャン（Dependabot/SCA）
- コンテナ：最小ベースイメージ、非 root 実行、不要ツール削除
- SBOM 生成（将来）

## 7. ログ/監査

- 成功/失敗ログイン、権限エラー、設定変更、お気に入り操作を監査ログ化
- PII/トークンは保存禁止、必要時はハッシュ化

## 8. レート制限/DoS

- IP/ユーザー単位のレート制限（例：/shelters 60 rpm）
- キャッシュ・CDN で吸収、バックエンドへの到達を抑制

## 9. 脅威分析（簡易 STRIDE）

| 脅威                   | 例               | 対策                         |
| ---------------------- | ---------------- | ---------------------------- |
| Spoofing               | 偽トークン       | Firebase 検証、時刻検証      |
| Tampering              | パラメータ改ざん | スキーマ検証、署名/CSRF 対策 |
| Repudiation            | 否認             | 監査ログ、trace_id           |
| Information Disclosure | PII 漏えい       | 最小化・マスキング・権限制御 |
| DoS                    | 過剰リクエスト   | レート制限、タイムアウト     |
| Elevation of Privilege | 権限昇格         | RBAC、レビュー/テスト        |

## 10. セキュリティテスト

- SAST/Dependency Scan：CI で自動
- DAST：ステージングに対して軽量実行
- ペネトレーション（将来）：対外実施前提で計画

---

### 作成時の注意点

- **データ分類**を先に決め、以降の設計（ログ/権限/マスキング）に反映。
- **実装可能な対策**だけを書き、運用/テストまで落とし込む。
- **レート制限と上限**を数値で定義（乱用/DoS 対策）。
