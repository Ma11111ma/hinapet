# docs/logging_design.md（ログ設計書）

## 1. 目的

運用・保守・監査・不正検知に資するログの要件・構造・運用方法を定義。

## 2. ログ種別

- アプリケーションログ（API 入口/出口、ビジネスイベント）
- 監査ログ（認証/認可、設定変更、お気に入り操作）
- アクセスログ（リバースプロキシ）
- DB ログ（スロークエリ）
- クライアント RUM（Web-Vitals）

## 3. 形式（JSON Lines）

```json
{
  "ts": "2025-10-14T08:00:00.123Z",
  "level": "INFO",
  "trace_id": "c6f...",
  "span_id": "a1b...",
  "user_id": "uid_123",
  "route": "/shelters",
  "method": "GET",
  "status": 200,
  "latency_ms": 42,
  "params": { "lat": 35.6, "lng": 139.7, "radius": 1000 },
  "msg": "shelters_search_ok"
}
```

## 4. フィールド定義

| フィールド          | 必須 | 説明                       |
| ------------------- | ---- | -------------------------- |
| ts                  | ◯    | ISO8601                    |
| level               | ◯    | DEBUG/INFO/WARN/ERROR      |
| trace_id/span_id    | ◯    | APM 連携                   |
| user_id             | △    | PII 最小化、匿名 ID でも可 |
| route/method/status | ◯    | API 基本                   |
| latency_ms          | ◯    | 性能分析                   |
| params              | △    | 機微情報はマスク           |
| msg                 | ◯    | 事象の概要                 |

## 5. マスキング/PII

- 個人情報/トークンは保存禁止 or マスキング（\*\*\*）
- 監査対象操作のみ最小限の属性を保持（原則匿名化）

## 6. 保持/転送

- 保持期間：アプリログ 30 日、監査 180 日
- 転送：標準出力 → 集約（ELK/Cloud Logging）→ 永続

## 7. ログレベル指針

- DEBUG：本番では OFF（例外的に短期有効）
- INFO：正常イベント
- WARN：リトライ/軽微障害
- ERROR：ユーザー影響あり、アラート連動対象

## 8. 運用

- 検索クエリのプリセット（trace_id、user_id、route、status:>=500）
- ダッシュボード：5xx 推移、遅延ヒートマップ、上位エラー

### 作成時の注意点

- 目的別のログ設計（運用/監査/開発）を分ける。
- 機微情報の扱いを先に決めて実装に落とす（フィルタ/マスク）。
- 追跡可能性（trace_id）を全レイヤで貫通させる。
